<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fincas Hosta · Dashboard de Obra</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg:#0f1216; --panel:#141922; --muted:#8b93a7; --text:#e8ecf3; --ok:#1bd760; --warn:#f6c453; --late:#ff4d4d; --late-lite:#ff9aa0; --accent:#3b82f6; --accent-2:#a78bfa;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0c0f14, #0f1216 35%, #0b0e13);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    a{color:var(--accent)}
    .app{display:grid;grid-template-columns:300px 1fr;grid-template-rows:auto 1fr;gap:16px;min-height:100vh;padding:16px}
    header{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;background:rgba(20,25,34,.9);backdrop-filter:blur(6px);border:1px solid #222834;border-radius:16px;padding:12px 16px}
    .brand{display:flex;gap:12px;align-items:center}
    .brand .logo{width:36px;height:36px;border-radius:10px;background:conic-gradient(from 220deg at 50% 50%, var(--accent), var(--accent-2), var(--ok));box-shadow:0 0 0 3px #1e2430 inset}
    .brand h1{font-size:18px;margin:0;letter-spacing:.3px}
    .meta{display:flex;gap:16px;align-items:center}
    .badge{padding:6px 10px;border-radius:999px;background:#1b2230;border:1px solid #262e40;color:#cbd5e1;font-size:12px}
    .desk{font-weight:600}
    .desk a{color:#cbd5e1;text-decoration:none}

    /* Sidebar */
    .sidebar{background:var(--panel);border:1px solid #202636;border-radius:16px;padding:14px;display:flex;flex-direction:column;gap:14px}
    .section h3{margin:4px 0 8px;font-size:13px;color:#aab3c7;text-transform:uppercase;letter-spacing:.12em}
    .chip{display:inline-flex;gap:6px;align-items:center;border:1px solid #2c3447;background:#171c26;color:#c8d0df;border-radius:10px;padding:6px 8px;font-size:12px;cursor:pointer;user-select:none}
    .chip[data-active="true"]{border-color:var(--accent);box-shadow:0 0 0 1px var(--accent) inset}
    .divider{height:1px;background:#1f2634;margin:8px 0}
    .stat{display:flex;justify-content:space-between;align-items:center;font-size:13px;color:#cdd6e7}
    .stat b{font-size:16px}

    /* Main layout */
    .main{display:grid;grid-template-rows:auto auto 1fr;gap:16px}

    /* Timeline */
    .timeline{background:var(--panel);border:1px solid #202636;border-radius:16px;padding:14px}
    .row{display:grid;grid-template-columns:160px 1fr;gap:14px;align-items:center}
    .row .lbl{font-size:12px;color:#aab3c7;text-transform:uppercase;letter-spacing:.14em}
    .bar{position:relative;height:22px;background:#141a24;border:1px solid #232b3b;border-radius:999px;overflow:hidden}
    .bar .seg{position:absolute;top:0;bottom:0}
    .seg.ok{background:linear-gradient(90deg, #1bd760, #18c155)}
    .seg.late{background:linear-gradient(90deg, #ff4d4d, #ff2e63)}
    .seg.late-lite{background:linear-gradient(90deg, #ff9aa0, #ff7a85)}
    .seg.plan{background:linear-gradient(90deg, rgba(59,130,246,.35), rgba(167,139,250,.35))}
    .marker{position:absolute;top:-6px;width:2px;height:34px;background:#fff;border-radius:2px;box-shadow:0 0 0 2px rgba(255,255,255,.12)}
    .marker::after{content:attr(data-label);position:absolute;top:-22px;left:50%;transform:translateX(-50%);background:#0f141d;padding:4px 7px;border:1px solid #21304a;border-radius:6px;font-size:11px;color:#cbd5e1;white-space:nowrap}
    .legend{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .legend .key{display:flex;gap:8px;align-items:center;font-size:12px;color:#cbd5e1;background:#171c26;border:1px solid #263148;border-radius:10px;padding:6px 8px}
    .key i{display:inline-block;width:14px;height:8px;border-radius:4px}
    .key .i-ok{background:#1bd760}
    .key .i-late{background:#ff4d4d}
    .key .i-late-lite{background:#ff9aa0}
    .key .i-plan{background:#6aa2ff}

    /* Cards */
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
    .card{background:var(--panel);border:1px solid #202636;border-radius:16px;padding:14px}
    .card h3{margin:0 0 10px;font-size:16px}

    /* Actas table */
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th{font-size:12px;color:#aab3c7;text-align:left;text-transform:uppercase;letter-spacing:.14em}
    td,th{padding:8px}
    tbody tr{background:#111720;border:1px solid #1d2536}
    tbody tr:hover{background:#131b28}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;font-size:12px}
    .pill.ok{background:rgba(27,215,96,.15);color:#aef4c9;border:1px solid rgba(27,215,96,.35)}
    .pill.late{background:rgba(255,77,77,.12);color:#ffb4b4;border:1px solid rgba(255,77,77,.35)}
    .pill.late-lite{background:rgba(255,154,160,.12);color:#ffd1d4;border:1px solid rgba(255,154,160,.35)}
    .btn{cursor:pointer;background:#172033;border:1px solid #24314b;color:#e5ecf7;border-radius:10px;padding:8px 10px;font-size:13px}
    .btn:hover{background:#1a2740}
    .btn.inline{padding:4px 8px;font-size:12px}

    /* Modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(5,8,12,.6)}
    .modal[open]{display:flex}
    .modal .panel{width:min(920px,92vw);background:#0d121b;border:1px solid #21304a;border-radius:16px;overflow:hidden}
    .modal header{border-radius:16px 16px 0 0}
    .modal .content{padding:16px;display:grid;grid-template-columns:1fr 360px;gap:16px}
    .gallery{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .ph{aspect-ratio:16/10;border-radius:12px;display:grid;place-items:center;background:linear-gradient(135deg,#1a2231,#0f1622);border:1px dashed #30405a;color:#9fb3d9;font-size:12px}

    /* Animations */
    @keyframes pop{0%{transform:scale(.98);opacity:0}100%{transform:scale(1);opacity:1}}
    .animate-pop{animation:pop .35s ease}

    /* Responsive */
    @media (max-width:1100px){
      .app{grid-template-columns:1fr}
      .grid{grid-template-columns:1fr}
      .modal .content{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand"><div class="logo" aria-hidden="true"></div><h1>Fincas Hosta · Dashboard de Obra</h1></div>
      <div class="meta">
        <span class="badge">Inicio plan: <b id="startPlan"></b></span>
        <span class="badge">Entrega plan: <b id="deadlinePlan"></b></span>
        <span class="badge">Hoy: <b id="today"></b></span>
        <span class="badge desk"><a href="https://www.co-arquitectura.com" target="_blank" rel="noopener">www.co-arquitectura.com</a></span>
      </div>
    </header>

    <aside class="sidebar">
      <div class="section">
        <h3>Filtros rápidos</h3>
        <div style="display:flex;flex-wrap:wrap;gap:8px">
          <div class="chip" data-filter="all" data-active="true">Todo</div>
          <div class="chip" data-filter="ok">On time</div>
          <div class="chip" data-filter="late">Demoras imputables cliente</div>
          <div class="chip" data-filter="late-lite">Otras demoras</div>
          <div class="chip" data-filter="decision">Decisiones</div>
          <div class="chip" data-filter="acta">Actas</div>
        </div>
      </div>
      <div class="divider"></div>
      <div class="section">
        <h3>Estado</h3>
        <div class="stat"><span>Progreso previsto</span><b id="plannedPct">0%</b></div>
        <div class="stat"><span>Progreso real</span><b id="actualPct">0%</b></div>
        <div class="stat"><span>Demora total</span><b id="totalDelay">0 días</b></div>
        <div class="stat"><span>Demora por cliente</span><b id="clientDelay">0 días</b></div>
        <div class="stat"><span>Demora terceros</span><b id="otherDelay">0 días</b></div>
      </div>
      <div class="divider"></div>
      <div class="section">
        <h3>Exportar</h3>
        <button class="btn" id="btnExportCsv">Exportar demoras CSV</button>
      </div>
      <div class="divider"></div>
      <div class="section">
        <h3>Guía rápida</h3>
        <ul style="margin:0 0 0 18px; padding:0; color:#cdd6e7; font-size:13px; display:grid; gap:6px">
          <li>Barra azul translúcida: cronograma planificado.</li>
          <li>Verde: hitos ejecutados en plazo.</li>
          <li>Rojo fuerte: demoras aceptadas por el cliente.</li>
          <li>Rojo claro: demoras de terceros o imprevistos.</li>
          <li>Click en filas para abrir actas, fotos y decisiones.</li>
        </ul>
      </div>
    </aside>

    <main class="main">
      <section class="timeline">
        <div class="row" style="margin-bottom:8px">
          <div class="lbl">Cronograma</div>
          <div class="bar" id="timelineBar">
            <div class="seg plan" id="planSeg"></div>
            <!-- real and delay segments injected here -->
            <div class="marker" id="todayMarker" data-label="Hoy"></div>
            <div class="marker" id="deadlineMarker" data-label="Entrega plan"></div>
          </div>
        </div>
        <div class="legend">
          <div class="key"><i class="i-plan"></i> Planificado</div>
          <div class="key"><i class="i-ok"></i> En plazo</div>
          <div class="key"><i class="i-late-lite"></i> Demora terceros</div>
          <div class="key"><i class="i-late"></i> Demora aceptada cliente</div>
        </div>
      </section>

      <section class="grid">
        <div class="card">
          <h3>Actas y visitas</h3>
          <table>
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Tipo</th>
                <th>Resumen</th>
                <th>Estado</th>
                <th>Impacto</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
        <div class="card">
          <h3>Demoras por causante</h3>
          <canvas id="chartDelays" height="240"></canvas>
          <div class="divider" style="margin:12px 0"></div>
          <h3>Burndown de plazo</h3>
          <canvas id="chartBurndown" height="240"></canvas>
        </div>
      </section>

      <section class="card">
        <h3>Notas clave</h3>
        <ul style="margin:0 0 0 18px; padding:0; color:#cdd6e7; font-size:14px; display:grid; gap:6px">
          <li>Las demoras se calculan automáticamente a partir de las actas con impacto en la planificación.</li>
          <li>Si el cliente acepta una modificación con impacto, la demora se marca en rojo fuerte y se imputa al cliente.</li>
          <li>El resumen bajo la línea de tiempo muestra el total de días de retraso y su reparto por causante.</li>
          <li>Puedes filtrar por tipo de registro con los chips de la izquierda.</li>
          <li>Exporta un CSV con el detalle para adjuntar al libro de órdenes.</li>
        </ul>
      </section>
    </main>
  </div>

  <!-- Modal -->
  <dialog class="modal" id="dlg">
    <div class="panel animate-pop">
      <header style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:#121927;border-bottom:1px solid #1d2a41">
        <div style="display:flex;gap:10px;align-items:center">
          <span class="badge" id="dlgType"></span>
          <b id="dlgTitle" style="font-size:16px"></b>
        </div>
        <button class="btn inline" onclick="dlg.close()">Cerrar</button>
      </header>
      <div class="content">
        <div>
          <p id="dlgDesc" style="color:#cbd5e1;line-height:1.45"></p>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:10px">
            <div class="pill ok" id="dlgStatus">En plazo</div>
            <div class="pill" id="dlgImpact">Sin impacto</div>
          </div>
          <div class="divider" style="margin:14px 0"></div>
          <div class="gallery" id="dlgGallery"></div>
        </div>
        <aside>
          <div style="background:#0f1622;border:1px solid #20304a;border-radius:12px;padding:10px">
            <h4 style="margin:0 0 8px">Detalle de impacto</h4>
            <ul id="dlgBullets" style="margin:0 0 0 18px;display:grid;gap:6px;color:#cbd5e1"></ul>
          </div>
        </aside>
      </div>
    </div>
  </dialog>

  <script>
    // ========= Datos de ejemplo =========
    const data = {
      projectName: 'Fincas Hosta',
      firm: 'www.co-arquitectura.com',
      startPlan: '2025-05-05',
      deadlinePlan: '2025-10-01',
      today: '2025-10-18',
      tasks: [
        { id:'t1', date:'2025-05-06', type:'acta', title:'Replanteo inicial', status:'ok', impactDays:0, causedBy:null, clientAccepted:false, desc:'Tomas de medidas y verificación estructural. Todo conforme.', images:['Replanteo','Estructura'] },
        { id:'t2', date:'2025-05-20', type:'decision', title:'Cambio de pavimento sala', status:'late', impactDays:21, causedBy:'Cliente', clientAccepted:true, desc:'Sustitución a parquet nogal seleccionado por el cliente.', images:['Muestra','Plano detalle'] },
        { id:'t3', date:'2025-06-03', type:'acta', title:'Demora fontanería cocina', status:'late-lite', impactDays:7, causedBy:'Fontanero', clientAccepted:false, desc:'Rehacer conexiones de desagüe por fuga en pruebas.', images:['Fuga','Corrección'] },
        { id:'t4', date:'2025-06-28', type:'decision', title:'Mobiliario a medida', status:'ok', impactDays:0, causedBy:null, clientAccepted:false, desc:'Validación de planos de carpintería sin impacto en ruta crítica.', images:['Render','Plano'] },
        { id:'t5', date:'2025-07-11', type:'acta', title:'Retraso proveedor sanitarios', status:'late-lite', impactDays:5, causedBy:'Proveedor', clientAccepted:false, desc:'Entrega parcial por rotura de stock. Replanificación de montaje.', images:['Albarán','Alternativas'] },
        { id:'t6', date:'2025-08-08', type:'decision', title:'Cambio luminarias lineales', status:'late', impactDays:10, causedBy:'Cliente', clientAccepted:true, desc:'Sustitución por modelo dimmable. Plazo adicional de suministro.', images:['Catálogo','Sección'] },
        { id:'t7', date:'2025-09-03', type:'acta', title:'Retraso licencia terraza', status:'late-lite', impactDays:10, causedBy:'Ayuntamiento', clientAccepted:false, desc:'Esperando resolución definitiva de ocupación.', images:['Solicitud','Informe técnico'] },
        { id:'t8', date:'2025-09-24', type:'acta', title:'Pruebas instalaciones', status:'ok', impactDays:0, causedBy:null, clientAccepted:false, desc:'Eléctrica y climatización dentro de parámetros.', images:['Termografía','Cuadro'] },
        { id:'t9', date:'2025-10-10', type:'acta', title:'Retrabajo pintura pasillo', status:'late-lite', impactDays:3, causedBy:'Pintor', clientAccepted:false, desc:'Rechazo por diferencias de tono. 2 manos adicionales.', images:['Muestra','Revisión'] }
      ]
    }

    // ========= Utilidades =========
    const fmt = (d)=>new Date(d).toLocaleDateString('es-ES')
    const daysBetween = (a,b)=> Math.round((new Date(b)-new Date(a))/(1000*60*60*24))

    // ========= Estado agregado =========
    const totalPlanDays = daysBetween(data.startPlan, data.deadlinePlan)
    const daysSinceStart = daysBetween(data.startPlan, data.today)
    const plannedPct = Math.max(0, Math.min(100, Math.round((daysSinceStart/totalPlanDays)*100)))
    const totalDelayClient = data.tasks.filter(t=>t.status==='late' && t.clientAccepted).reduce((s,t)=>s+t.impactDays,0)
    const totalDelayOthers = data.tasks.filter(t=>t.status==='late-lite').reduce((s,t)=>s+t.impactDays,0)
    const totalDelay = totalDelayClient + totalDelayOthers

    // Suponemos avance real: on-time hasta hoy menos demoras efectivas
    const effectiveEnd = new Date(new Date(data.deadlinePlan).getTime() + totalDelay*86400000)
    const actualPct = Math.max(0, Math.min(100, Math.round((daysBetween(data.startPlan, data.today) / daysBetween(data.startPlan, effectiveEnd))*100)))

    // ========= Header stats =========
    document.getElementById('startPlan').textContent = fmt(data.startPlan)
    document.getElementById('deadlinePlan').textContent = fmt(data.deadlinePlan)
    document.getElementById('today').textContent = fmt(data.today)
    document.getElementById('plannedPct').textContent = plannedPct + '%'
    document.getElementById('actualPct').textContent = actualPct + '%'
    document.getElementById('totalDelay').textContent = totalDelay + ' días'
    document.getElementById('clientDelay').textContent = totalDelayClient + ' días'
    document.getElementById('otherDelay').textContent = totalDelayOthers + ' días'

    // ========= Timeline render =========
    const bar = document.getElementById('timelineBar')
    const planSeg = document.getElementById('planSeg')
    const todayMarker = document.getElementById('todayMarker')
    const deadlineMarker = document.getElementById('deadlineMarker')

    const barPad = 6
    const width = ()=> bar.clientWidth - barPad*2
    const xOf = (date)=>{
      const d0 = new Date(data.startPlan).getTime()
      const d1 = new Date(data.deadlinePlan).getTime()
      const dx = new Date(date).getTime()
      const t = (dx - d0) / (d1 - d0)
      return Math.max(0, Math.min(1, t)) * width() + barPad
    }

    function drawTimeline(){
      planSeg.style.left = barPad + 'px'
      planSeg.style.width = width() + 'px'

      // Real progress assumed = min(hoy, fin plan)
      const realEndPlan = new Date(Math.min(new Date(data.today), new Date(data.deadlinePlan)))
      const realWidth = xOf(realEndPlan) - barPad
      const realSeg = document.createElement('div')
      realSeg.className = 'seg ok'
      realSeg.style.left = barPad+'px'
      realSeg.style.width = Math.max(0, realWidth) + 'px'
      bar.appendChild(realSeg)

      // Delay segments appended after deadline
      const afterLeft = xOf(data.deadlinePlan)
      let cum = 0
      if(totalDelayOthers>0){
        const s = document.createElement('div')
        s.className='seg late-lite'
        s.style.left = afterLeft + 'px'
        s.style.width = (width()* (totalDelayOthers/totalPlanDays)) + 'px'
        s.title = `Demora terceros: ${totalDelayOthers} días`
        bar.appendChild(s)
        cum += totalDelayOthers
      }
      if(totalDelayClient>0){
        const s = document.createElement('div')
        s.className='seg late'
        s.style.left = afterLeft + (width()* (cum/totalPlanDays)) + 'px'
        s.style.width = (width()* (totalDelayClient/totalPlanDays)) + 'px'
        s.title = `Demora aceptada cliente: ${totalDelayClient} días`
        bar.appendChild(s)
      }

      // Markers
      todayMarker.style.left = xOf(data.today) + 'px'
      deadlineMarker.style.left = xOf(data.deadlinePlan) + 'px'
    }

    // Redraw on resize
    new ResizeObserver(()=>{ bar.querySelectorAll('.seg:not(.plan)').forEach(n=>n.remove()); drawTimeline() }).observe(bar)
    drawTimeline()

    // ========= Rows =========
    const tbody = document.getElementById('rows')
    function pill(status){
      const el = document.createElement('span');
      el.className = `pill ${status}`
      el.textContent = status === 'ok' ? 'En plazo' : (status==='late'?'Demora cliente':'Demora terceros')
      return el
    }
    function impactText(t){
      if(t.impactDays===0) return '—'
      const who = t.status==='late' ? 'Cliente' : t.causedBy || 'Terceros'
      return `${t.impactDays} días · Causante: ${who}`
    }

    function renderRows(filter='all'){
      tbody.innerHTML=''
      data.tasks
        .filter(t=> filter==='all' || (filter==='decision'? t.type==='decision' : filter==='acta'? t.type==='acta' : t.status===filter))
        .sort((a,b)=> new Date(a.date)-new Date(b.date))
        .forEach(t=>{
          const tr = document.createElement('tr')
          tr.style.cursor='pointer'
          tr.onclick = ()=> openDlg(t)
          tr.innerHTML = `
            <td>${fmt(t.date)}</td>
            <td>${t.type==='acta'?'Acta':'Decisión'}</td>
            <td>${t.title}</td>
            <td></td>
            <td>${impactText(t)}</td>
            <td><button class='btn inline'>Ver</button></td>
          `
          tr.children[3].appendChild(pill(t.status))
          tbody.appendChild(tr)
        })
    }
    renderRows()

    // ========= Filters =========
    document.querySelectorAll('.chip').forEach(ch=>{
      ch.addEventListener('click', ()=>{
        document.querySelectorAll('.chip').forEach(c=>c.dataset.active='false')
        ch.dataset.active='true'
        renderRows(ch.dataset.filter)
      })
    })

    // ========= Modal =========
    const dlg = document.getElementById('dlg')
    function ph(label){
      const d = document.createElement('div'); d.className='ph'; d.textContent=label; return d
    }
    function openDlg(t){
      document.getElementById('dlgType').textContent = t.type==='acta'?'ACTA':'DECISIÓN'
      document.getElementById('dlgTitle').textContent = `${fmt(t.date)} · ${t.title}`
      document.getElementById('dlgDesc').textContent = t.desc

      const st = document.getElementById('dlgStatus')
      st.className = `pill ${t.status}`
      st.textContent = t.status==='ok'?'En plazo':(t.status==='late'?'Demora aceptada cliente':'Demora terceros')

      const imp = document.getElementById('dlgImpact')
      if(t.impactDays>0){
        imp.className = 'pill late-lite'
        const who = t.status==='late' ? 'Cliente' : (t.causedBy||'Terceros')
        imp.textContent = `${t.impactDays} días · Causante: ${who}`
      } else { imp.className='pill ok'; imp.textContent='Sin impacto' }

      const gal = document.getElementById('dlgGallery'); gal.innerHTML=''
      t.images.forEach(i=> gal.appendChild(ph(i)))

      const bullets = document.getElementById('dlgBullets'); bullets.innerHTML=''
      const items = []
      if(t.type==='decision') items.push('Se registra decisión con firma digital del cliente')
      if(t.impactDays>0) items.push(`Impacto en cronograma: ${t.impactDays} días`)
      if(t.status==='late') items.push('Demora imputable al cliente por cambio aceptado')
      if(t.status==='late-lite') items.push(`Demora imputable a ${t.causedBy||'terceros'}`)
      if(t.status==='ok') items.push('Sin impacto en la ruta crítica')
      items.push('Adjuntar al libro de órdenes y timeline')
      items.forEach(tx=>{ const li=document.createElement('li'); li.textContent=tx; bullets.appendChild(li) })

      dlg.showModal()
    }

    // ========= Charts =========
    function buildCharts(){
      // Demoras por causante
      const agg = {}
      data.tasks.filter(t=>t.impactDays>0).forEach(t=>{
        const who = t.status==='late'? 'Cliente' : (t.causedBy||'Terceros')
        agg[who] = (agg[who]||0) + t.impactDays
      })
      const labels = Object.keys(agg)
      const values = Object.values(agg)
      new Chart(document.getElementById('chartDelays'), {
        type:'bar',
        data:{labels, datasets:[{label:'Días de demora', data:values}]},
        options:{responsive:true, plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}}, y:{beginAtZero:true}}}
      })

      // Burndown: días restantes vs fecha
      const start = new Date(data.startPlan)
      const endPlan = new Date(data.deadlinePlan)
      const endReal = new Date(endPlan.getTime() + totalDelay*86400000)
      const pts = []
      const step = 7 // semanal
      for(let d=new Date(start); d<=endReal; d.setDate(d.getDate()+step)){
        const plannedLeft = Math.max(0, daysBetween(d, endPlan))
        const realLeft = Math.max(0, daysBetween(d, endReal))
        pts.push({d: new Date(d), plannedLeft, realLeft})
      }
      new Chart(document.getElementById('chartBurndown'), {
        type:'line',
        data:{
          labels: pts.map(p=> p.d.toLocaleDateString('es-ES')),
          datasets:[
            {label:'Plan', data: pts.map(p=>p.plannedLeft), borderWidth:2, fill:false},
            {label:'Real', data: pts.map(p=>p.realLeft), borderWidth:2, fill:false}
          ]
        },
        options:{responsive:true, plugins:{legend:{position:'bottom'}}, scales:{y:{beginAtZero:true}}}
      })
    }
    buildCharts()

    // ========= Export CSV =========
    function exportCsv(){
      const rows = [['Fecha','Tipo','Título','Estado','Impacto días','Causante','Aceptado cliente']]
      data.tasks.forEach(t=>{
        rows.push([fmt(t.date), t.type, t.title, t.status, t.impactDays, t.status==='late'?'Cliente':(t.causedBy||''), t.clientAccepted?'Sí':'No'])
      })
      const csv = rows.map(r=> r.map(x=>`"${String(x).replaceAll('"','\"')}"`).join(',')).join('\n')
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'})
      const a = document.createElement('a')
      a.href = URL.createObjectURL(blob)
      a.download = 'fincas-hosta-demoras.csv'
      document.body.appendChild(a); a.click(); a.remove()
    }
    document.getElementById('btnExportCsv').addEventListener('click', exportCsv)
  </script>
</body>
</html>
